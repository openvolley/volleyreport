---
output:
  html_document: default
---

```{r chunkopts, eval = TRUE, echo = FALSE}

knitr::opts_chunk$set(eval = TRUE, echo = FALSE, 
                      message = TRUE, 
                      warning = TRUE, 
                      tidy = FALSE, cache = FALSE, include = TRUE, dpi = 72, fig.width = 12, fig.height = 8, fig.align = "center", results = "markup")
options(knitr.kable.NA = "")

tf_abs <- function(f) system.file(file.path("extdata", f), package = "volleyreport")
kable_format <- "html"

```

<style>.main {width: 1100px;}

#main .nav-pills > li > a:hover {
  background-color: #18348E;
}

#main .nav-pills > li.active > a,
#main .nav-pills > li.active > a:hover,
#main .nav-pills > li.active > a:focus {
  background-color: #18348E;
}

h1,h2,h3,h4,h5,h6,legend{ color:#18348E; }

#content{ max-width: 95% }

#content pre { background:#f3f6f6; color:#404040; }
#content pre.sourceCode{ background-color: #FFF; }

#nav-top span.glyphicon { color:#18348E; }
a { color:#18348E; /*#060F6A;*/
}

#main a {
    background-image: linear-gradient(180deg,#18349e,#18349e);
    color:#18348e;
}

#postamble .date {
    color: #211103; /*#f8e5ee;*/
}

#content .highlighted{
    background:#FACB01;
}

#content .row > div {
  border: 1px solid grey;
}

#main .row > div {
  border: 1px solid grey;
}

thead > tr { border: 1px solid `r vsx$css$header_colour` }

.table { margin-bottom: 8px; }

.wcol { padding-left: 2px; padding-right: 2px; }
.widetable { width: 100%; }

.mtbl { width: 100%; }
.mtbl > tbody > tr { background: #fff; }
.mtbl td, .mtbl th { vertical-align: top; padding: 3px; }
</style>

```{r}
if (vsx$shiny_progress) try(shiny::setProgress(value = 0.3, message = "Generating header"), silent = TRUE)
```

```{r mr1html, warning = FALSE, results = "asis"}

if (!is.null(vsx$header_extra_pre)) cat(vsx$header_extra_pre, "\n")

if (!is.null(vsx$icon)) {
    cat("<table class=\"mtbl\"><tr><td width=\"15%\">\n")
    cat("<p style=\"margin:0;\"><img src=\"", vsx$icon, "\" style=\"max-width: 90%; max-height: 90%;\" /></p>\n", sep = "")
    cat("</td>\n")
    cat("<td width=\"85%\">\n")
}

cat("<table class=\"mtbl\"><tr>\n")

cat("<td width=\"25%\">")
volleyreport:::vr_content_match_outcome(vsx, kable_format)
cat("</td>\n")

cat("<td width=\"17%\">")
volleyreport:::vr_content_match_date(vsx, kable_format)
cat("</td>\n")

cat("<td width=\"22%\">")
volleyreport:::vr_content_match_refs(vsx, kable_format)
cat("</td>\n")

cat("<td width=\"36%\">")
volleyreport:::vr_content_partial_scores(vsx, kable_format)
cat("</td></tr></table>\n")
if (!is.null(vsx$icon)) {
    cat("</td></tr></table>\n")
}
```

```{r mr_score_ev, warning = FALSE, eval = vsx$style %in% c("ov1"), results = "asis", fig.height = 0.75, fig.width = 12}
p <- if (sum(vsx$x$point, na.rm = TRUE) < 2) NULL else volleyreport:::vr_content_score_evplot(vsx, font_size = 8)
if (!is.null(p)) print(p)
```

```{r mr2_home_html, warning = FALSE, results = "asis"}
cat("<table class=\"mtbl\"><tr>\n")
cat("<td width=\"100%\">")
volleyreport:::vr_content_team_table(vsx, kable_format, which_team = "home")
cat("</td>\n")
cat("</tr></table>\n")

```

```{r mr3_home_html, warning = FALSE, results = "asis"}
cat("<table class=\"mtbl\"><tr>\n")
cat("<td width=\"25%\">")
volleyreport:::vr_content_team_staff(vsx, kable_format, which_team = "home")
cat("</td>\n")

cat("<td width=\"75%\">")
volleyreport:::vr_content_team_set_summary(vsx, kable_format, which_team = "home")
cat("</td>\n")
cat("</tr></table>\n")

```

```{r mr2_visiting_html, warning = FALSE, results = "asis"}
cat("<table class=\"mtbl\"><tr>\n")
cat("<td width=\"100%\">")
volleyreport:::vr_content_team_table(vsx, kable_format, which_team = "visiting")
cat("</td>\n")
cat("</tr></table>\n")

```

```{r mr3_visiting_html, warning = FALSE, results = "asis"}
cat("<table class=\"mtbl\"><tr>\n")
cat("<td width=\"25%\">")
volleyreport:::vr_content_team_staff(vsx, kable_format, which_team = "visiting")
cat("</td>\n")

cat("<td width=\"75%\">")
volleyreport:::vr_content_team_set_summary(vsx, kable_format, which_team = "visiting")
cat("</td>\n")
cat("</tr></table>\n")

```

```{r}
if (vsx$shiny_progress) try(shiny::setProgress(value = 0.8, message = "Generating footer"), silent = TRUE)
```

```{r fr0, warning = FALSE, results = "asis"}
cat("<table class=\"mtbl\"><tr>\n")
## left-hand content panel
cat("<td width=\"83%\">\n")
```

```{r fr1, warning = FALSE, results = "asis"}
## team names
cat("<table class=\"mtbl\"><tr>\n")
cat0("<td width=\"50%\" style=\"font-size:", vsx$base_font_size * 10/12, "px; font-weight:bold; text-align:center; border-left:", vsx$css$border, "; border-top:", vsx$css$border, ";\">", vsx$meta$teams$team[1], "</td>\n")
cat0("<td width=\"50%\" style=\"font-size:", vsx$base_font_size * 10/12, "px; font-weight:bold; text-align:center; border-left:", vsx$css$border, "; border-top:", vsx$css$border, "; border-right:", vsx$css$border, ";\">", vsx$meta$teams$team[2], "</td>\n")
cat("</tr></table>\n")
cat("<table class=\"mtbl\"><tr>\n")
```

```{r fr2, warning = FALSE, results = "asis"}
## home team points by rot
if (vsx$style %in% c("ov1")) {
    cat("<td width=\"27%\">\n")
    if (!grepl("beach", vsx$file_type)) cat(volleyreport:::vr_content_points_by_rot(vsx, kable_format, which_team = "home"))
    cat("</td>\n")
} else {
    ## default, show points by rot vertically and other stuff next to it
    ## wtf? this doesn't work if it's an if { ...} else {...} block??
    if (!grepl("beach", vsx$file_type)) cat0("<td width=\"10%\" style=\"border-right:", vsx$css$border, ";\">\n")
    if (!grepl("beach", vsx$file_type)) cat(volleyreport:::vr_content_points_by_rot(vsx, kable_format, which_team = "home"))
    if (!grepl("beach", vsx$file_type)) cat("</td>\n")
    if (!grepl("beach", vsx$file_type)) cat("<td width=\"17%\">\n")
    if (grepl("beach", vsx$file_type)) cat("<td width=\"27%\">\n")
    hteach <- volleyreport:::vr_content_team_each(vsx, kable_format, which_team = "home")
    for (this in hteach) cat(this, "\n")
    cat("</td>\n")
}
```

```{r fr3, warning = FALSE, results = "asis"}
## middle content
cat0("<td width=\"46%\" style=\"border-right:", vsx$css$border, "; border-left:", vsx$css$border, ";\">\n")
volleyreport:::vr_content_kill_on_rec(vsx, kable_format, eval_codes = c("#", "+", "#+"), hdr = "1st Attack AFTER POSITIVE RECEPTION (+#)")
volleyreport:::vr_content_kill_on_rec(vsx, kable_format, eval_codes = c("-", "!", "-/"), hdr = "1st Attack AFTER NEGATIVE RECEPTION (-!)")
volleyreport:::vr_content_kill_in_trans(vsx, kable_format)
cat("</td>\n")
```

```{r fr4, warning = FALSE, results = "asis"}
## visiting team points by rot
if (vsx$style %in% c("ov1")) {
    cat("<td width=\"27%\">\n")
    if (!grepl("beach", vsx$file_type)) cat(volleyreport:::vr_content_points_by_rot(vsx, kable_format, which_team = "visiting"))
    cat("</td>\n")
} else {
    cat0("<td width=\"", if (!grepl("beach", vsx$file_type)) 17 else 27, "%\" style=\"border-right:", vsx$css$border, ";\">\n")
    vteach <- volleyreport:::vr_content_team_each(vsx, kable_format, which_team = "visiting")
    for (this in vteach) cat(this, "\n")
    cat("</td>\n")
    ## wtf? this doesn't work if it's an if { ...} block??
    if (!grepl("beach", vsx$file_type)) cat0("<td width=\"10%\">\n")
    if (!grepl("beach", vsx$file_type)) cat(volleyreport:::vr_content_points_by_rot(vsx, kable_format, which_team = "visiting"))
    if (!grepl("beach", vsx$file_type)) cat("</td>\n")
}
```

```{r fr5, warning = FALSE, results = "asis"}
cat("</tr></table>\n")
## the right-hand panel for the report legend
cat0("<td width=\"16.7%\">\n")
volleyreport:::vr_content_key(vsx, kable_format)
cat("</td>\n")

cat("</tr></table>\n")
```

```{r footnotes, warning = FALSE, results = "asis"}
if (length(vsx$footnotes) > 0) cat0("<div style=\"float:right; font-size:", vsx$base_font_size * 8/12, "px;\">Note", if (length(footnotes) > 1) "s", ": ", paste(footnotes, collapse = " "), "</p>")
```

`r if (vsx$shiny_progress) try(shiny::setProgress(value = 0.95, message = paste0("Converting to ", toupper(vsx$format))), silent = TRUE)`

